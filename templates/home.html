<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - MyApp</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <!-- Display only the username -->
            <h1>Welcome to Twotter, {{ user.username }}</h1>
            <div class="profile-info">
                <h2>{{ user.username }}</h2>
                <p><strong>@{{ user.username }}</strong></p>
                <p class="bio">{{ user.bio }}</p>
            </div>
        </header>

        <div class="actions">
            <a href="{{ url_for('profile') }}" class="btn">Go to Profile</a>
            <a href="{{ url_for('logout') }}" class="btn">Logout</a>
        </div>

        <!-- Add Tweet Form -->
        <section class="tweet-form">
            <h2>What's on your mind?</h2>
            <form id="tweet-form" action="{{ url_for('home') }}" method="POST">
                <textarea name="content" id="content" rows="4" placeholder="Write your tweet..." required></textarea>
                <button type="submit" class="btn">Tweet</button>
            </form>
        </section>

        <!-- Display Database Feed -->
        <section class="tweet-feed">
            <h2>Your Feed (Database Posts)</h2>
            {% if db_posts %}
                <ul id="feed-list">
                    {% for post in db_posts %}
                        <li class="tweet">
                            <div class="tweet-header">
                                <span class="username">@{{ post.username }}</span>
                                <span class="tweet-time">{{ post.timestamp }}</span>
                            </div>
                            <p class="tweet-body">{{ post.body }}</p>
                            <div class="tweet-footer">
                                <span class="like-count">{{ post.likeCount }} Likes</span>
                                <button class="like-btn">Like</button>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No database tweets available.</p>
            {% endif %}
        </section>

        <!-- Display JSONPlaceholder Feed -->
        <section class="tweet-feed">
            <h2>JSONPlaceholder Feed</h2>
            {% if jsonplaceholder_posts %}
                <ul id="json-placeholder-feed">
                    {% for post in jsonplaceholder_posts %}
                        <li class="tweet">
                            <div class="tweet-header">
                                <span class="username">@{{ post.username }}</span>
                                <span class="tweet-time">{{ post.timestamp }}</span>
                            </div>
                            <p class="tweet-body">{{ post.body }}</p>
                            <div class="tweet-footer">
                                <span class="like-count">{{ post.likeCount }} Likes</span>
                                <button class="like-btn">Like</button>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No tweets from JSONPlaceholder available.</p>
            {% endif %}
        </section>
    </div>

    <script>
        // Handle tweet form submission via AJAX
        document.getElementById("tweet-form").addEventListener("submit", function(event) {
            event.preventDefault(); // Prevent default form submission

            let content = document.getElementById("content").value;
            if (!content.trim()) return;

            // Send the tweet via AJAX
            fetch("{{ url_for('home') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                // Update the tweet feed with the new tweet
                let feedList = document.getElementById("feed-list");
                let newTweet = data.new_post;
                let tweetItem = document.createElement("li");
                tweetItem.classList.add("tweet");

                tweetItem.innerHTML = ` 
                    <div class="tweet-header">
                        <span class="username">@${newTweet.username}</span>
                        <span class="tweet-time">${newTweet.timestamp}</span>
                    </div>
                    <p class="tweet-body">${newTweet.body}</p>
                    <div class="tweet-footer">
                        <span class="like-count">${newTweet.likeCount} Likes</span>
                        <button class="like-btn">Like</button>
                    </div>
                `;
                feedList.insertBefore(tweetItem, feedList.firstChild); // Add the new tweet at the top
                document.getElementById("content").value = ""; // Clear the tweet input field
            })
            .catch(error => {
                console.error("Error posting tweet:", error);
            });
        });

        // Handle like button click
        document.querySelectorAll('.like-btn').forEach(button => {
            button.addEventListener('click', function() {
                let tweetItem = this.closest('.tweet');
                let likeCount = tweetItem.querySelector('.like-count');
                let currentLikes = parseInt(likeCount.textContent);
                likeCount.textContent = (currentLikes + 1) + " Likes";
            });
        });
    </script>
</body>
</html>
